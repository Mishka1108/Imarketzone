<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>рЃърЃарЃЮрЃцрЃўрЃџрЃўрЃА рЃњрЃЋрЃћрЃарЃЊрЃў</h1>
  </header>
  <div class="card-header">
    <h2>рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ</h2>
  </div>
</div>

<div class="profile">
  <!-- рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЎрЃЮрЃЏрЃърЃЮрЃюрЃћрЃюрЃбрЃў -->
  <div class="profile-information">
    <div class="image-upload-container">
      <!-- рЃњрЃљрЃЏрЃЮрЃАрЃгрЃЮрЃарЃћрЃЉрЃБрЃџрЃў рЃърЃарЃЮрЃцрЃўрЃџрЃўрЃА рЃАрЃБрЃарЃљрЃЌрЃўрЃА input рЃДрЃЋрЃћрЃџрЃљ рЃЉрЃарЃљрЃБрЃќрЃћрЃарЃўрЃАрЃЌрЃЋрЃўрЃА -->
      <input 
        type="file" 
        id="profileImageInput" 
        accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
        capture="environment"
        style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
        (change)="onFileSelected($event, 'profile')"
        #profileInput
        tabindex="-1"
      />
    
      <!-- рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў hidden input рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА -->
      <input 
        type="file" 
        id="profileImageInputAlt" 
        accept="image/*" 
        style="display: none;"
        (change)="onAlternativeFileSelected($event, 'profile')"
      />

      <img 
        [src]="currentUser?.profileImage || 'https://i.ibb.co/GvshXkLK/307ce493-b254-4b2d-8ba4-d12c080d6651.jpg'" 
        id="profileImagePreview" 
        class="profileimg" 
        alt="Profile Image"
        (click)="triggerFileInput()"
        style="cursor: pointer;"
      />
          
      <!-- рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃдрЃўрЃџрЃљрЃЎрЃў -->
      <label for="profileImageInputAlt" class="android-upload-btn" 
             style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
        ­ЪЊи рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃцрЃЮрЃбрЃЮ
      </label>
        <button class="btn messages-btn" mat-flat-button (click)="openMessages()">
    <span class="button-content">
      ­Ъњг рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃћрЃЉрЃў
      <span class="message-badge" *ngIf="unreadMessagesCount > 0">
        {{ unreadMessagesCount }}
      </span>
    </span>
  </button>
      <button class="btn" mat-flat-button (click)="logout()">рЃњрЃљрЃАрЃЋрЃџрЃљ</button>
    </div>
    
    <div class="user-info" *ngIf="currentUser">
      <div class="username">
        <span class="name">{{currentUser.name}}</span>
        <span class="name">{{currentUser.secondName}}</span>
      </div>
      <div>
        <p>рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃў: {{currentUser.phone}}</p>
        <p>рЃћрЃџрЃцрЃЮрЃАрЃбрЃљ: {{currentUser.email}}</p>
        <p>рЃърЃўрЃарЃљрЃЊрЃў рЃюрЃЮрЃЏрЃћрЃарЃў: {{currentUser.personalNumber}}</p>
      </div>
      
      <!-- РюЁ ENHANCED: Product limit display with loading state -->
      <div class="user-actions">
        <div class="product-counter" [class.loading]="isLoadingProducts">
          <span class="pro">рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ:</span>
          <span class="num" 
                [ngClass]="{'limit-reached': isProductLimitReached(), 'limit-near': getCurrentProductsCount() >= 4}">
            <span *ngIf="!isLoadingProducts">{{getCurrentProductsCount()}} / {{MAX_PRODUCTS_ALLOWED}}</span>
            <span *ngIf="isLoadingProducts">РЈ│ рЃбрЃЋрЃўрЃарЃЌрЃљрЃЋрЃА...</span>
          </span>
        </div>
        
        <!-- РюЁ ENHANCED: Clear limit status messages -->
        <div class="limit-status" *ngIf="!isLoadingProducts">
          <p *ngIf="isProductLimitReached()" class="limit-warning">
            Рџа№ИЈ рЃЏрЃўрЃдрЃгрЃћрЃБрЃџрЃўрЃљ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃўрЃА рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ ({{MAX_PRODUCTS_ALLOWED}})!
          </p>
          <p *ngIf="!isProductLimitReached() && getCurrentProductsCount() >= 4" class="limit-near-warning">
            РџА рЃЏрЃљрЃџрЃћ рЃЏрЃўрЃљрЃдрЃгрЃћрЃЋрЃЌ рЃџрЃўрЃЏрЃўрЃбрЃА! рЃЊрЃљрЃарЃЕрЃћрЃюрЃўрЃџрЃўрЃљ {{getRemainingProductsCount()}} рЃљрЃЊрЃњрЃўрЃџрЃў
          </p>
          <p *ngIf="canAddMoreProducts() && getCurrentProductsCount() < 4" class="remaining-products">
            РюЁ рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљрЃЌ рЃЊрЃљрЃљрЃЏрЃљрЃбрЃЮрЃЌ рЃЎрЃўрЃЊрЃћрЃЋ {{getRemainingProductsCount()}} рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў
          </p>
        </div>
        
        <!-- РюЁ Loading state for limit status -->
        <div class="limit-status" *ngIf="isLoadingProducts">
          <p class="loading-status">­Ъћё рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃўрЃА рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ рЃЏрЃЮрЃгрЃЏрЃЊрЃћрЃЉрЃљ...</p>
        </div>
      </div>
      
      <!-- РюЁ ENHANCED: Button with proper disable logic and loading states -->
      <div class="btndiv">
        <button 
          mat-flat-button 
          class="btn add-product-btn" 
          (click)="toggleProductForm()" 
          [disabled]="(!canAddMoreProducts() && !productFormVisible) || isLoadingProducts || isUploading"
          [ngClass]="{
            'btn-disabled': (!canAddMoreProducts() && !productFormVisible) || isLoadingProducts,
            'btn-close': productFormVisible,
            'btn-add': !productFormVisible && canAddMoreProducts(),
            'btn-loading': isLoadingProducts
          }">
          
          <!-- Loading states -->
          <span *ngIf="isLoadingProducts">РЈ│ рЃбрЃЋрЃўрЃарЃЌрЃљрЃЋрЃА...</span>
          <span *ngIf="isUploading && !isLoadingProducts">­ЪЊц рЃўрЃбрЃЋрЃўрЃарЃЌрЃћрЃЉрЃљ...</span>
          
          <!-- Normal states -->
          <span *ngIf="!isLoadingProducts && !isUploading && productFormVisible">РЮї рЃцрЃЮрЃарЃЏрЃўрЃА рЃЊрЃљрЃ«рЃБрЃарЃЋрЃљ</span>
          <span *ngIf="!isLoadingProducts && !isUploading && !productFormVisible && canAddMoreProducts()">РъЋ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ</span>
          <span *ngIf="!isLoadingProducts && !isUploading && !productFormVisible && !canAddMoreProducts()">­ЪџФ рЃџрЃўрЃЏрЃўрЃбрЃў рЃЏрЃўрЃдрЃгрЃћрЃБрЃџрЃўрЃљ</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- РюЁ ENHANCED: Product form with limit checks -->
<div class="conteiner">
  <div class="card3" *ngIf="productFormVisible && canAddMoreProducts()">
    <!-- РюЁ Dynamic header with remaining count -->
    <h2>рЃерЃћрЃўрЃДрЃЋрЃљрЃюрЃћрЃЌ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ 
      <small>(рЃЊрЃљрЃарЃЕрЃћрЃюрЃўрЃџрЃўрЃљ {{getRemainingProductsCount()}} рЃљрЃЊрЃњрЃўрЃџрЃў)</small>
    </h2>
    
    <form [formGroup]="productForm" class="card4" (ngSubmit)="addProduct()">
      <mat-form-field class="example-full-width">
        <mat-label>рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў</mat-label>
        <input matInput formControlName="title">
        <mat-error *ngIf="productForm.controls.title.hasError('required')">
          рЃАрЃљрЃ«рЃћрЃџрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ</mat-label>
        <input type="text" matInput formControlName="category" [matAutocomplete]="auto">
        <mat-autocomplete #auto="matAutocomplete">
          <mat-option *ngFor="let category of filteredCategories" [value]="category">
            {{ category }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="productForm.controls.category.hasError('required')">
          рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃњрЃљрЃЏрЃЮрЃерЃЋрЃћрЃЉрЃўрЃА рЃгрЃћрЃџрЃў</mat-label>
        <input matInput type="number" formControlName="year">
        <mat-error *ngIf="productForm.controls.year.hasError('required')">
          рЃгрЃћрЃџрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.year.hasError('min') || productForm.controls.year.hasError('max')">
          рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЌ рЃАрЃгрЃЮрЃарЃў рЃгрЃћрЃџрЃў (2000-рЃЊрЃљрЃю рЃЊрЃдрЃћрЃЏрЃЊрЃћ)
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃцрЃљрЃАрЃў</mat-label>
        <input matInput type="number" formControlName="price">
        <mat-error *ngIf="productForm.controls.price.hasError('required')">
          рЃцрЃљрЃАрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.price.hasError('min')">
          рЃцрЃљрЃАрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЊрЃљрЃЊрЃћрЃЉрЃўрЃЌрЃў рЃарЃўрЃфрЃ«рЃЋрЃў
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў</mat-label>
        <input matInput type="tel" formControlName="phone">
        <mat-error *ngIf="productForm.controls.phone.hasError('required')">
          рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.phone.hasError('pattern')">
          рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА 9-рЃЊрЃљрЃю 15-рЃЏрЃЊрЃћ рЃфрЃўрЃцрЃарЃў
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>рЃўрЃЏрЃћрЃўрЃџрЃў</mat-label>
        <input matInput type="email" formControlName="email">
        <mat-error *ngIf="productForm.controls.email.hasError('required')">
          рЃўрЃЏрЃћрЃўрЃџрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.email.hasError('email')">
          рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЌ рЃАрЃгрЃЮрЃарЃў рЃўрЃЏрЃћрЃўрЃџрЃў
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃљрЃдрЃгрЃћрЃарЃљ</mat-label>
        <textarea matInput formControlName="description" rows="4"></textarea>
        <mat-error *ngIf="productForm.controls.description.hasError('required')">
          рЃљрЃдрЃгрЃћрЃарЃљ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>рЃЦрЃљрЃџрЃљрЃЦрЃў</mat-label>
        <input type="text" matInput formControlName="city" [matAutocomplete]="autoCity">
        <mat-autocomplete #autoCity="matAutocomplete">
          <mat-option *ngFor="let city of filteredCities" [value]="city">
            {{ city }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="productForm.controls['city'].hasError('required')">
          рЃЦрЃљрЃџрЃљрЃЦрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>

      <!-- рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ -->
      <div class="image-upload-section">
        <h3>рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃў (рЃЏрЃљрЃЦрЃА. 3 рЃАрЃБрЃарЃљрЃЌрЃў)</h3>
        
        <!-- рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃАрЃБрЃарЃљрЃЌрЃў -->
        <div class="image-upload-group">
          <h4>рЃАрЃБрЃарЃљрЃЌрЃў 1</h4>
          <input 
            type="file" 
            id="productImageInput1" 
            accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
            capture="environment"
            style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
            (change)="onFileSelected($event, 'product', 0)"
            #productInput1
            tabindex="-1"
          />

          <!-- рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў hidden input рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА -->
          <input 
            type="file" 
            id="productImageInput1Alt" 
            accept="image/*" 
            style="display: none;"
            (change)="onAlternativeFileSelected($event, 'product', 0)"
          />

          <div class="image-upload-area" (click)="triggerProductImageInput(0)"> 
            <div *ngIf="!productImagePreviews[0]" class="upload-placeholder">
              <span class="upload-icon">­ЪЊи</span>
              <p>рЃЊрЃљрЃљрЃГрЃўрЃарЃћрЃЌ рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃАрЃљрЃарЃЕрЃћрЃЋрЃљрЃЊ</p>
            </div>
            <img *ngIf="productImagePreviews[0]" [src]="productImagePreviews[0]" class="product-image-preview" alt="Product Preview 1" />
            <button *ngIf="productImagePreviews[0]" type="button" class="remove-image-btn" (click)="removeProductImage(0); $event.stopPropagation()">
              РюЋ
            </button>
          </div>

          <!-- рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃдрЃўрЃџрЃљрЃЎрЃў -->
          <label for="productImageInput1Alt" class="android-upload-btn" 
                style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
            ­ЪЊи рЃљрЃџрЃб. рЃАрЃБрЃарЃљрЃЌрЃў 1
          </label>
        </div>

        <!-- рЃЏрЃћрЃЮрЃарЃћ рЃАрЃБрЃарЃљрЃЌрЃў -->
        <div class="image-upload-group">
          <h4>рЃАрЃБрЃарЃљрЃЌрЃў 2</h4>
          <input 
            type="file" 
            id="productImageInput2" 
            accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
            capture="environment"
            style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
            (change)="onFileSelected($event, 'product', 1)"
            #productInput2
            tabindex="-1"
          />

          <!-- рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў hidden input рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА -->
          <input 
            type="file" 
            id="productImageInput2Alt" 
            accept="image/*" 
            style="display: none;"
            (change)="onAlternativeFileSelected($event, 'product', 1)"
          />

          <div class="image-upload-area" (click)="triggerProductImageInput(1)"> 
            <div *ngIf="!productImagePreviews[1]" class="upload-placeholder">
              <span class="upload-icon">­ЪЊи</span>
              <p>рЃЊрЃљрЃљрЃГрЃўрЃарЃћрЃЌ рЃЏрЃћрЃЮрЃарЃћ рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃАрЃљрЃарЃЕрЃћрЃЋрЃљрЃЊ</p>
            </div>
            <img *ngIf="productImagePreviews[1]" [src]="productImagePreviews[1]" class="product-image-preview" alt="Product Preview 2" />
            <button *ngIf="productImagePreviews[1]" type="button" class="remove-image-btn" (click)="removeProductImage(1); $event.stopPropagation()">
              РюЋ
            </button>
          </div>

          <!-- рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃдрЃўрЃџрЃљрЃЎрЃў -->
          <label for="productImageInput2Alt" class="android-upload-btn" 
                style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
            ­ЪЊи рЃљрЃџрЃб. рЃАрЃБрЃарЃљрЃЌрЃў 2
          </label>
        </div>

        <!-- рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃАрЃБрЃарЃљрЃЌрЃў -->
        <div class="image-upload-group">
          <h4>рЃАрЃБрЃарЃљрЃЌрЃў 3</h4>
          <input 
            type="file" 
            id="productImageInput3" 
            accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
            capture="environment"
            style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
            (change)="onFileSelected($event, 'product', 2)"
            #productInput3
            tabindex="-1"
          />

          <!-- рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў hidden input рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА -->
          <input 
            type="file" 
            id="productImageInput3Alt" 
            accept="image/*" 
            style="display: none;"
            (change)="onAlternativeFileSelected($event, 'product', 2)"
          />

          <div class="image-upload-area" (click)="triggerProductImageInput(2)"> 
            <div *ngIf="!productImagePreviews[2]" class="upload-placeholder">
              <span class="upload-icon">­ЪЊи</span>
              <p>рЃЊрЃљрЃљрЃГрЃўрЃарЃћрЃЌ рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃАрЃљрЃарЃЕрЃћрЃЋрЃљрЃЊ</p>
            </div>
            <img *ngIf="productImagePreviews[2]" [src]="productImagePreviews[2]" class="product-image-preview" alt="Product Preview 3" />
            <button *ngIf="productImagePreviews[2]" type="button" class="remove-image-btn" (click)="removeProductImage(2); $event.stopPropagation()">
              РюЋ
            </button>
          </div>

          <!-- рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃдрЃўрЃџрЃљрЃЎрЃў -->
          <label for="productImageInput3Alt" class="android-upload-btn" 
                style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
            ­ЪЊи рЃљрЃџрЃб. рЃАрЃБрЃарЃљрЃЌрЃў 3
          </label>
        </div>

        <!-- рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃўрЃА рЃАрЃбрЃљрЃбрЃўрЃАрЃбрЃўрЃЎрЃљ -->
        <div class="image-upload-stats" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
          <p><strong>рЃљрЃбрЃЋрЃўрЃарЃЌрЃБрЃџрЃў рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃў: {{getUploadedImagesCount()}} / {{MAX_PRODUCT_IMAGES}}</strong></p>
          <p *ngIf="!hasProductImages()" style="color: #ff9800;">
            Рџа№ИЈ рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏ рЃћрЃарЃЌрЃў рЃАрЃБрЃарЃљрЃЌрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
          </p>
          <p *ngIf="hasProductImages()" style="color: #4caf50;">
            РюЁ рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃў рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃљрЃбрЃЋрЃўрЃарЃЌрЃБрЃџрЃўрЃљ
          </p>
        </div>
      </div>
      
      <!-- РюЁ ENHANCED: Form actions with double-check and loading states -->
      <div class="form-actions">
        <button 
          mat-flat-button 
          type="submit" 
          class="btn submit-btn" 
          [disabled]="productForm.invalid || isUploading || isCompressing || !canAddMoreProducts() || !hasProductImages()">
          
          <span *ngIf="isCompressing">­Ъќ╝№ИЈ рЃАрЃБрЃарЃљрЃЌрЃў рЃўрЃЎрЃБрЃЏрЃерЃћрЃЉрЃљ...</span>
          <span *ngIf="isUploading && !isCompressing">­ЪЊц рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў рЃўрЃбрЃЋрЃўрЃарЃЌрЃћрЃЉрЃљ...</span>
          <span *ngIf="!isUploading && !isCompressing">­Ъј» рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ ({{getRemainingProductsCount()}} рЃљрЃЊрЃњрЃўрЃџрЃў)</span>
        </button>
        <button mat-flat-button type="button" class="btn cancel-btn" (click)="toggleProductForm()" [disabled]="isUploading || isCompressing">
          РЮї рЃњрЃљрЃБрЃЦрЃЏрЃћрЃЉрЃљ
        </button>
      </div>
    </form>
  </div>
  
  <!-- РюЁ NEW: Message when form is hidden due to limit -->
  <div class="card3 limit-reached-card" *ngIf="productFormVisible && !canAddMoreProducts()" style="text-align: center; padding: 30px; background: #fff3cd; border: 2px solid #ffc107;">
    <h2 style="color: #856404;">­ЪџФ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃўрЃА рЃџрЃўрЃЏрЃўрЃбрЃў рЃЏрЃўрЃдрЃгрЃћрЃБрЃџрЃўрЃљ!</h2>
    <p style="color: #856404; font-size: 16px;">
      рЃЌрЃЦрЃЋрЃћрЃю рЃБрЃЎрЃЋрЃћ рЃњрЃљрЃЦрЃЋрЃЌ {{MAX_PRODUCTS_ALLOWED}} рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў. рЃљрЃ«рЃџрЃўрЃА рЃЊрЃљрЃАрЃљрЃЏрЃљрЃбрЃћрЃЉрЃџрЃљрЃЊ, рЃърЃўрЃарЃЋрЃћрЃџ рЃДрЃЋрЃћрЃДрЃљрЃюрЃљрЃќрЃћ рЃгрЃљрЃерЃљрЃџрЃћрЃЌ рЃарЃЮрЃЏрЃћрЃџрЃўрЃЏрЃћ рЃљрЃарЃАрЃћрЃЉрЃБрЃџрЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў.
    </p>
    <button mat-flat-button class="btn" (click)="toggleProductForm()" style="background: #ffc107; color: #856404;">
      РюЁ рЃњрЃљрЃАрЃљрЃњрЃћрЃЉрЃўрЃљ
    </button>
  </div>
</div>

<!-- РюЁ ENHANCED: Products section header with clear count and loading state -->
<div class="products-header" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
  <h2 class="userproducts">рЃЕрЃћрЃЏрЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃў</h2> 
  <div class="products-count" style="background: #e3f2fd; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
    <span *ngIf="!isLoadingProducts">­ЪЊд {{getCurrentProductsCount()}} / {{MAX_PRODUCTS_ALLOWED}} рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў</span>
    <span *ngIf="isLoadingProducts">РЈ│ рЃбрЃЋрЃўрЃарЃЌрЃљрЃЋрЃА...</span>
  </div>
</div>

<!-- РюЁ Loading indicator for products -->
<div class="products-loading" *ngIf="isLoadingProducts" style="text-align: center; padding: 40px;">
  <mat-progress-spinner diameter="50" color="primary" mode="indeterminate"></mat-progress-spinner>
  <p style="margin-top: 15px; color: #666;">­Ъћё рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃў рЃўрЃбрЃЋрЃўрЃарЃЌрЃћрЃЉрЃљ...</p>
</div>

<!-- User products display -->
<div class="user-products-section" *ngIf="userProducts.length > 0 && !isLoadingProducts">
  <div class="products-grid">
    <div class="product-card" *ngFor="let product of userProducts; trackBy: trackByProductId"
       (click)="product ? openProductDetails(product) : null">
      
      <!-- рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃўрЃА рЃАрЃџрЃљрЃўрЃЊрЃћрЃарЃў -->
      <div class="product-images">
        <swiper-container 
          slides-per-view="1" 
          pagination="true" 
          navigation="true"
          class="product-swiper">
          
          <swiper-slide *ngFor="let image of getAllProductImages(product); let i = index; trackBy: trackByImageUrl">
            <img [src]="image" 
                 class="swiperimage" 
                 [alt]="product.title + ' - рЃАрЃБрЃарЃљрЃЌрЃў ' + (i + 1)"
                 (error)="onImageError($event)">
          </swiper-slide>
          
          <!-- рЃЌрЃБ рЃАрЃБрЃарЃљрЃЌрЃў рЃљрЃа рЃљрЃарЃўрЃА, default image -->
          <swiper-slide *ngIf="getAllProductImages(product).length === 0">
            <img src="/assets/default-product.jpg" 
                 class="swiperimage" 
                 [alt]="product.title + ' - default рЃАрЃБрЃарЃљрЃЌрЃў'">
          </swiper-slide>
          
        </swiper-container>
        
        <!-- рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃўрЃА рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃўрЃА рЃЏрЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃћрЃџрЃў -->
        <ng-container *ngIf="getAllProductImages(product) as images">
          <div class="image-counter" *ngIf="images.length > 1">
            {{ images.length }} рЃАрЃБрЃарЃљрЃЌрЃў
          </div>
        </ng-container>
      </div>
      
      <!-- рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ -->
      <div class="product-info">
        <h3>{{ product.title }}</h3>
        <p class="product-category">{{ product.category }}</p>
        <p class="product-price">{{ product.price }} РѓЙ</p>
        <p class="product-year">рЃгрЃћрЃџрЃў: {{ product.year }}</p>
        <p class="product-location">{{ product.cities }}</p>
        <p class="product-date">рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ: {{ formatDate(product.createdAt) }}</p>
      </div>
      
      <!-- рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃўрЃА рЃдрЃўрЃџрЃљрЃЎрЃћрЃЉрЃў -->
      <div class="product-actions">
        <button mat-flat-button class="delete-btn" (click)="deleteProduct(product._id!); $event.stopPropagation()">
          ­ЪЌЉ№ИЈ рЃгрЃљрЃерЃџрЃљ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- РюЁ NEW: Empty state when no products and not loading -->
<div class="no-products-message" *ngIf="userProducts.length === 0 && !isLoadingProducts" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
  <div style="font-size: 64px; margin-bottom: 20px;">­ЪЊд</div>
  <h3 style="color: #6c757d; margin-bottom: 15px;">рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃў рЃ»рЃћрЃа рЃљрЃа рЃњрЃљрЃЦрЃЋрЃЌ рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў</h3>
  <p style="color: #6c757d; margin-bottom: 20px;">
    рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљрЃЌ рЃЊрЃљрЃљрЃЏрЃљрЃбрЃЮрЃЌ рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃБрЃЏ {{MAX_PRODUCTS_ALLOWED}} рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў
  </p>
  <button 
    mat-flat-button 
    class="btn" 
    (click)="toggleProductForm()" 
    *ngIf="canAddMoreProducts()"
    style="background: #007bff; color: white; padding: 12px 24px;">
    РъЋ рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ
  </button>
</div>

<!-- РюЁ ENHANCED: Global loading overlay for uploads -->
<div class="loading-overlay" *ngIf="(isUploading || isCompressing) && !isLoadingProducts" 
     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center;">
  <div class="loading-spinner" style="text-align: center; color: white; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px);">
    <mat-progress-spinner diameter="60" color="primary" mode="indeterminate"></mat-progress-spinner>
    <div style="margin-top: 20px;">
      <h3 style="color: white; margin-bottom: 10px;">
        <span *ngIf="isCompressing">­Ъќ╝№ИЈ рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃў рЃўрЃЎрЃБрЃЏрЃерЃћрЃЉрЃљ</span>
        <span *ngIf="isUploading && !isCompressing">­ЪЊц рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў рЃўрЃбрЃЋрЃўрЃарЃЌрЃћрЃЉрЃљ</span>
      </h3>
      <p style="color: #ccc; font-size: 14px;">
        <span *ngIf="isCompressing">рЃњрЃЌрЃ«рЃЮрЃЋрЃЌ рЃЏрЃЮрЃўрЃЌрЃЏрЃўрЃюрЃЮрЃЌ, рЃАрЃБрЃарЃљрЃЌрЃћрЃЉрЃў рЃЏрЃБрЃерЃљрЃЋрЃЊрЃћрЃЉрЃљ...</span>
        <span *ngIf="isUploading && !isCompressing">рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў рЃАрЃћрЃарЃЋрЃћрЃарЃќрЃћ рЃўрЃњрЃќрЃљрЃЋрЃюрЃћрЃЉрЃљ...</span>
      </p>
    </div>
  </div>
</div>