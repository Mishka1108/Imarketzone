<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>{{ 'PROFILE.PAGE_TITLE' | translate }}</h1>
  </header>
  <div class="card-header">
    <h2>{{ 'PROFILE.USER_INFO' | translate }}</h2>
  </div>
</div>

<div class="profile">
  <!-- ·Éû·Éò·É†·Éï·Éî·Éö·Éò ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·Éò -->
  <div class="profile-information">
    <div class="image-upload-container">
      <!-- ·Éí·Éê·Éõ·Éù·É°·É¨·Éù·É†·Éî·Éë·É£·Éö·Éò ·Éû·É†·Éù·É§·Éò·Éö·Éò·É° ·É°·É£·É†·Éê·Éó·Éò·É° input ·Éß·Éï·Éî·Éö·Éê ·Éë·É†·Éê·É£·Éñ·Éî·É†·Éò·É°·Éó·Éï·Éò·É° -->
      <input 
        type="file" 
        id="profileImageInput" 
        accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
        capture="environment"
        style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
        (change)="onFileSelected($event, 'profile')"
        #profileInput
        tabindex="-1"
      />
    
      <!-- ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò hidden input ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° -->
      <input 
        type="file" 
        id="profileImageInputAlt" 
        accept="image/*" 
        style="display: none;"
        (change)="onAlternativeFileSelected($event, 'profile')"
      />

      <img 
        [src]="currentUser?.profileImage || 'https://i.ibb.co/GvshXkLK/307ce493-b254-4b2d-8ba4-d12c080d6651.jpg'" 
        id="profileImagePreview" 
        class="profileimg" 
        alt="Profile Image"
        (click)="triggerFileInput()"
        style="cursor: pointer;"
      />
          
      <!-- ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò ·É¶·Éò·Éö·Éê·Éô·Éò -->
      <label for="profileImageInputAlt" class="android-upload-btn" 
             style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
        üì∑ {{ 'PROFILE.ALTERNATIVE_PHOTO' | translate }}
      </label>
        <button class="btn messages-btn" mat-flat-button (click)="openMessages()">
    <span class="button-content">
      üí¨ {{ 'PROFILE.MESSAGES' | translate }}
      <span class="message-badge" *ngIf="unreadMessagesCount > 0">
        {{ unreadMessagesCount }}
      </span>
    </span>
  </button>
      <button class="btn" mat-flat-button (click)="logout()">{{ 'PROFILE.LOGOUT' | translate }}</button>
    </div>
    
    <div class="user-info" *ngIf="currentUser">
      <div class="username">
        <span class="name">{{currentUser.name}}</span>
        <span class="name">{{currentUser.secondName}}</span>
      </div>
      <div>
        <p>{{ 'PROFILE.PHONE' | translate }}: {{currentUser.phone}}</p>
        <p>{{ 'PROFILE.EMAIL' | translate }}: {{currentUser.email}}</p>
        <p>{{ 'PROFILE.PERSONAL_NUMBER' | translate }}: {{currentUser.personalNumber}}</p>
      </div>
      
      <!-- ‚úÖ ENHANCED: Product limit display with loading state -->
      <div class="user-actions">
        <div class="product-counter" [class.loading]="isLoadingProducts">
          <span class="pro">{{ 'PROFILE.PRODUCT_QUANTITY' | translate }}:</span>
          <span class="num" 
                [ngClass]="{'limit-reached': isProductLimitReached(), 'limit-near': getCurrentProductsCount() >= 4}">
            <span *ngIf="!isLoadingProducts">{{getCurrentProductsCount()}} / {{MAX_PRODUCTS_ALLOWED}}</span>
            <span *ngIf="isLoadingProducts">‚è≥ {{ 'PROFILE.LOADING' | translate }}...</span>
          </span>
        </div>
        
        <!-- ‚úÖ ENHANCED: Clear limit status messages -->
        <div class="limit-status" *ngIf="!isLoadingProducts">
          <p *ngIf="isProductLimitReached()" class="limit-warning">
            ‚ö†Ô∏è {{ 'PROFILE.LIMIT_REACHED' | translate:{ max: MAX_PRODUCTS_ALLOWED } }}
          </p>
          <p *ngIf="!isProductLimitReached() && getCurrentProductsCount() >= 4" class="limit-near-warning">
            ‚ö° {{ 'PROFILE.LIMIT_NEAR' | translate:{ remaining: getRemainingProductsCount() } }}
          </p>
          <p *ngIf="canAddMoreProducts() && getCurrentProductsCount() < 4" class="remaining-products">
            ‚úÖ {{ 'PROFILE.CAN_ADD_MORE' | translate:{ remaining: getRemainingProductsCount() } }}
          </p>
        </div>
        
        <!-- ‚úÖ Loading state for limit status -->
        <div class="limit-status" *ngIf="isLoadingProducts">
          <p class="loading-status">üîÑ {{ 'PROFILE.CHECKING_QUANTITY' | translate }}...</p>
        </div>
      </div>
      
      <!-- ‚úÖ ENHANCED: Button with proper disable logic and loading states -->
      <div class="btndiv">
        <button 
          mat-flat-button 
          class="btn add-product-btn" 
          (click)="toggleProductForm()" 
          [disabled]="(!canAddMoreProducts() && !productFormVisible) || isLoadingProducts || isUploading"
          [ngClass]="{
            'btn-disabled': (!canAddMoreProducts() && !productFormVisible) || isLoadingProducts,
            'btn-close': productFormVisible,
            'btn-add': !productFormVisible && canAddMoreProducts(),
            'btn-loading': isLoadingProducts
          }">
          
          <!-- Loading states -->
          <span *ngIf="isLoadingProducts">‚è≥ {{ 'PROFILE.LOADING' | translate }}...</span>
          <span *ngIf="isUploading && !isLoadingProducts">üì§ {{ 'PROFILE.UPLOADING' | translate }}...</span>
          
          <!-- Normal states -->
          <span *ngIf="!isLoadingProducts && !isUploading && productFormVisible">‚ùå {{ 'PROFILE.CLOSE_FORM' | translate }}</span>
          <span *ngIf="!isLoadingProducts && !isUploading && !productFormVisible && canAddMoreProducts()">‚ûï {{ 'PROFILE.ADD_PRODUCT' | translate }}</span>
          <span *ngIf="!isLoadingProducts && !isUploading && !productFormVisible && !canAddMoreProducts()">üö´ {{ 'PROFILE.LIMIT_REACHED_SHORT' | translate }}</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ ENHANCED: Product form with limit checks -->
<div class="conteiner">
  <div class="card3" *ngIf="productFormVisible && canAddMoreProducts()">
    <!-- ‚úÖ Dynamic header with remaining count -->
    <h2>{{ 'PRODUCT_FORM.TITLE' | translate }}
      <small>({{ 'PRODUCT_FORM.REMAINING_SLOTS' | translate:{ remaining: getRemainingProductsCount() } }})</small>
    </h2>
    
    <form [formGroup]="productForm" class="card4" (ngSubmit)="addProduct()">
      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.PRODUCT_NAME' | translate }}</mat-label>
        <input matInput formControlName="title">
        <mat-error *ngIf="productForm.controls.title.hasError('required')">
          {{ 'PRODUCT_FORM.NAME_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.CATEGORY' | translate }}</mat-label>
        <input type="text" matInput formControlName="category" [matAutocomplete]="auto">
        <mat-autocomplete #auto="matAutocomplete">
          <mat-option *ngFor="let category of filteredCategories" [value]="category">
            {{ category }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="productForm.controls.category.hasError('required')">
          {{ 'PRODUCT_FORM.CATEGORY_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.YEAR' | translate }}</mat-label>
        <input matInput type="number" formControlName="year">
        <mat-error *ngIf="productForm.controls.year.hasError('required')">
          {{ 'PRODUCT_FORM.YEAR_REQUIRED' | translate }}
        </mat-error>
        <mat-error *ngIf="productForm.controls.year.hasError('min') || productForm.controls.year.hasError('max')">
          {{ 'PRODUCT_FORM.YEAR_INVALID' | translate }}
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.PRICE' | translate }}</mat-label>
        <input matInput type="number" formControlName="price">
        <mat-error *ngIf="productForm.controls.price.hasError('required')">
          {{ 'PRODUCT_FORM.PRICE_REQUIRED' | translate }}
        </mat-error>
        <mat-error *ngIf="productForm.controls.price.hasError('min')">
          {{ 'PRODUCT_FORM.PRICE_POSITIVE' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.PHONE_NUMBER' | translate }}</mat-label>
        <input matInput type="tel" formControlName="phone">
        <mat-error *ngIf="productForm.controls.phone.hasError('required')">
          {{ 'PRODUCT_FORM.PHONE_REQUIRED' | translate }}
        </mat-error>
        <mat-error *ngIf="productForm.controls.phone.hasError('pattern')">
          {{ 'PRODUCT_FORM.PHONE_INVALID' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.EMAIL_LABEL' | translate }}</mat-label>
        <input matInput type="email" formControlName="email">
        <mat-error *ngIf="productForm.controls.email.hasError('required')">
          {{ 'PRODUCT_FORM.EMAIL_REQUIRED' | translate }}
        </mat-error>
        <mat-error *ngIf="productForm.controls.email.hasError('email')">
          {{ 'PRODUCT_FORM.EMAIL_INVALID' | translate }}
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.DESCRIPTION' | translate }}</mat-label>
        <textarea matInput formControlName="description" rows="4"></textarea>
        <mat-error *ngIf="productForm.controls.description.hasError('required')">
          {{ 'PRODUCT_FORM.DESCRIPTION_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>{{ 'PRODUCT_FORM.CITY' | translate }}</mat-label>
        <input type="text" matInput formControlName="city" [matAutocomplete]="autoCity">
        <mat-autocomplete #autoCity="matAutocomplete">
          <mat-option *ngFor="let city of filteredCities" [value]="city">
            {{ city }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="productForm.controls['city'].hasError('required')">
          {{ 'PRODUCT_FORM.CITY_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <!-- ·Éû·É†·Éù·Éì·É£·É•·É¢·Éò·É° ·É°·É£·É†·Éê·Éó·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê -->
      <div class="image-upload-section">
        <h3>{{ 'PRODUCT_FORM.PRODUCT_IMAGES' | translate }}</h3>
        
        <!-- ·Éû·Éò·É†·Éï·Éî·Éö·Éò ·É°·É£·É†·Éê·Éó·Éò -->
        <div class="image-upload-group">
          <h4>{{ 'PRODUCT_FORM.IMAGE' | translate }} 1</h4>
          <input 
            type="file" 
            id="productImageInput1" 
            accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
            capture="environment"
            style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
            (change)="onFileSelected($event, 'product', 0)"
            #productInput1
            tabindex="-1"
          />

          <!-- ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò hidden input ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° -->
          <input 
            type="file" 
            id="productImageInput1Alt" 
            accept="image/*" 
            style="display: none;"
            (change)="onAlternativeFileSelected($event, 'product', 0)"
          />

          <div class="image-upload-area" (click)="triggerProductImageInput(0)"> 
            <div *ngIf="!productImagePreviews[0]" class="upload-placeholder">
              <span class="upload-icon">üì∑</span>
              <p>{{ 'PRODUCT_FORM.CLICK_TO_SELECT_IMAGE' | translate:{ number: 1 } }}</p>
            </div>
            <img *ngIf="productImagePreviews[0]" [src]="productImagePreviews[0]" class="product-image-preview" alt="Product Preview 1" />
            <button *ngIf="productImagePreviews[0]" type="button" class="remove-image-btn" (click)="removeProductImage(0); $event.stopPropagation()">
              ‚úï
            </button>
          </div>

          <!-- ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò ·É¶·Éò·Éö·Éê·Éô·Éò -->
          <label for="productImageInput1Alt" class="android-upload-btn" 
                style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
            üì∑ {{ 'PRODUCT_FORM.ALT_IMAGE' | translate }} 1
          </label>
        </div>

        <!-- ·Éõ·Éî·Éù·É†·Éî ·É°·É£·É†·Éê·Éó·Éò -->
        <div class="image-upload-group">
          <h4>{{ 'PRODUCT_FORM.IMAGE' | translate }} 2</h4>
          <input 
            type="file" 
            id="productImageInput2" 
            accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
            capture="environment"
            style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
            (change)="onFileSelected($event, 'product', 1)"
            #productInput2
            tabindex="-1"
          />

          <!-- ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò hidden input ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° -->
          <input 
            type="file" 
            id="productImageInput2Alt" 
            accept="image/*" 
            style="display: none;"
            (change)="onAlternativeFileSelected($event, 'product', 1)"
          />

          <div class="image-upload-area" (click)="triggerProductImageInput(1)"> 
            <div *ngIf="!productImagePreviews[1]" class="upload-placeholder">
              <span class="upload-icon">üì∑</span>
              <p>{{ 'PRODUCT_FORM.CLICK_TO_SELECT_IMAGE' | translate:{ number: 2 } }}</p>
            </div>
            <img *ngIf="productImagePreviews[1]" [src]="productImagePreviews[1]" class="product-image-preview" alt="Product Preview 2" />
            <button *ngIf="productImagePreviews[1]" type="button" class="remove-image-btn" (click)="removeProductImage(1); $event.stopPropagation()">
              ‚úï
            </button>
          </div>

          <!-- ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò ·É¶·Éò·Éö·Éê·Éô·Éò -->
          <label for="productImageInput2Alt" class="android-upload-btn" 
                style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
            üì∑ {{ 'PRODUCT_FORM.ALT_IMAGE' | translate }} 2
          </label>
        </div>

        <!-- ·Éõ·Éî·É°·Éê·Éõ·Éî ·É°·É£·É†·Éê·Éó·Éò -->
        <div class="image-upload-group">
          <h4>{{ 'PRODUCT_FORM.IMAGE' | translate }} 3</h4>
          <input 
            type="file" 
            id="productImageInput3" 
            accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
            capture="environment"
            style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
            (change)="onFileSelected($event, 'product', 2)"
            #productInput3
            tabindex="-1"
          />

          <!-- ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò hidden input ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° -->
          <input 
            type="file" 
            id="productImageInput3Alt" 
            accept="image/*" 
            style="display: none;"
            (change)="onAlternativeFileSelected($event, 'product', 2)"
          />

          <div class="image-upload-area" (click)="triggerProductImageInput(2)"> 
            <div *ngIf="!productImagePreviews[2]" class="upload-placeholder">
              <span class="upload-icon">üì∑</span>
              <p>{{ 'PRODUCT_FORM.CLICK_TO_SELECT_IMAGE' | translate:{ number: 3 } }}</p>
            </div>
            <img *ngIf="productImagePreviews[2]" [src]="productImagePreviews[2]" class="product-image-preview" alt="Product Preview 3" />
            <button *ngIf="productImagePreviews[2]" type="button" class="remove-image-btn" (click)="removeProductImage(2); $event.stopPropagation()">
              ‚úï
            </button>
          </div>

          <!-- ·Éê·Éú·Éì·É†·Éù·Éò·Éì·Éò·É°·Éó·Éï·Éò·É° ·Éê·Éö·É¢·Éî·É†·Éú·Éê·É¢·Éò·É£·Éö·Éò ·É¶·Éò·Éö·Éê·Éô·Éò -->
          <label for="productImageInput3Alt" class="android-upload-btn" 
                style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
            üì∑ {{ 'PRODUCT_FORM.ALT_IMAGE' | translate }} 3
          </label>
        </div>

        <!-- ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·É°·É¢·Éê·É¢·Éò·É°·É¢·Éò·Éô·Éê -->
        <div class="image-upload-stats" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
          <p><strong>{{ 'PRODUCT_FORM.UPLOADED_IMAGES' | translate }}: {{getUploadedImagesCount()}} / {{MAX_PRODUCT_IMAGES}}</strong></p>
          <p *ngIf="!hasProductImages()" style="color: #ff9800;">
            ‚ö†Ô∏è {{ 'PRODUCT_FORM.MIN_ONE_IMAGE' | translate }}
          </p>
          <p *ngIf="hasProductImages()" style="color: #4caf50;">
            ‚úÖ {{ 'PRODUCT_FORM.IMAGES_UPLOADED' | translate }}
          </p>
        </div>
      </div>
      
      <!-- ‚úÖ ENHANCED: Form actions with double-check and loading states -->
      <div class="form-actions">
        <button 
          mat-flat-button 
          type="submit" 
          class="btn submit-btn" 
          [disabled]="productForm.invalid || isUploading || isCompressing || !canAddMoreProducts() || !hasProductImages()">
          
          <span *ngIf="isCompressing">üñºÔ∏è {{ 'PRODUCT_FORM.COMPRESSING' | translate }}...</span>
          <span *ngIf="isUploading && !isCompressing">üì§ {{ 'PRODUCT_FORM.UPLOADING_PRODUCT' | translate }}...</span>
          <span *ngIf="!isUploading && !isCompressing">üéØ {{ 'PRODUCT_FORM.ADD_PRODUCT_BTN' | translate:{ remaining: getRemainingProductsCount() } }}</span>
        </button>
        <button mat-flat-button type="button" class="btn cancel-btn" (click)="toggleProductForm()" [disabled]="isUploading || isCompressing">
          ‚ùå {{ 'PRODUCT_FORM.CANCEL' | translate }}
        </button>
      </div>
    </form>
  </div>
  
  <!-- ‚úÖ NEW: Message when form is hidden due to limit -->
  <div class="card3 limit-reached-card" *ngIf="productFormVisible && !canAddMoreProducts()" style="text-align: center; padding: 30px; background: #fff3cd; border: 2px solid #ffc107;">
    <h2 style="color: #856404;">üö´ {{ 'PRODUCT_FORM.LIMIT_REACHED_TITLE' | translate }}</h2>
    <p style="color: #856404; font-size: 16px;">
      {{ 'PRODUCT_FORM.LIMIT_REACHED_MESSAGE' | translate:{ max: MAX_PRODUCTS_ALLOWED } }}
    </p>
    <button mat-flat-button class="btn" (click)="toggleProductForm()" style="background: #ffc107; color: #856404;">
      ‚úÖ {{ 'PRODUCT_FORM.UNDERSTOOD' | translate }}
    </button>
  </div>
</div>

<!-- ‚úÖ ENHANCED: Products section header with clear count and loading state -->
<div class="products-header" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
  <h2 class="userproducts">{{ 'PRODUCTS.MY_PRODUCTS' | translate }}</h2> 
  <div class="products-count" style="background: #e3f2fd; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
    <span *ngIf="!isLoadingProducts">üì¶ {{getCurrentProductsCount()}} / {{MAX_PRODUCTS_ALLOWED}} {{ 'PRODUCTS.PRODUCT' | translate }}</span>
    <span *ngIf="isLoadingProducts">‚è≥ {{ 'PROFILE.LOADING' | translate }}...</span>
  </div>
</div>

<!-- ‚úÖ Loading indicator for products -->
<div class="products-loading" *ngIf="isLoadingProducts" style="text-align: center; padding: 40px;">
  <mat-progress-spinner diameter="50" color="primary" mode="indeterminate"></mat-progress-spinner>
  <p style="margin-top: 15px; color: #666;">üîÑ {{ 'PRODUCTS.LOADING_PRODUCTS' | translate }}...</p>
</div>

<!-- User products display -->
<div class="user-products-section" *ngIf="userProducts.length > 0 && !isLoadingProducts">
  <div class="products-grid">
    <div class="product-card" *ngFor="let product of userProducts; trackBy: trackByProductId"
       (click)="product ? openProductDetails(product) : null">
      
      <!-- ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·É°·Éö·Éê·Éò·Éì·Éî·É†·Éò -->
      <div class="product-images">
        <swiper-container 
          slides-per-view="1" 
          pagination="true" 
          navigation="true"
          class="product-swiper">
          
          <swiper-slide *ngFor="let image of getAllProductImages(product); let i = index; trackBy: trackByImageUrl">
            <img [src]="image" 
                 class="swiperimage" 
                 [alt]="product.title + ' - ' + ('PRODUCTS.IMAGE' | translate) + ' ' + (i + 1)"
                 (error)="onImageError($event)">
          </swiper-slide>
          
          <!-- ·Éó·É£ ·É°·É£·É†·Éê·Éó·Éò ·Éê·É† ·Éê·É†·Éò·É°, default image -->
          <swiper-slide *ngIf="getAllProductImages(product).length === 0">
            <img src="/assets/default-product.jpg" 
                 class="swiperimage" 
                 [alt]="product.title + ' - ' + ('PRODUCTS.DEFAULT_IMAGE' | translate)">
          </swiper-slide>
          
        </swiper-container>
        
        <!-- ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éò·É° ·Éõ·Éê·É©·Éï·Éî·Éú·Éî·Éë·Éî·Éö·Éò -->
        <ng-container *ngIf="getAllProductImages(product) as images">
          <div class="image-counter" *ngIf="images.length > 1">
            {{ images.length }} {{ 'PRODUCTS.IMAGES' | translate }}
          </div>
        </ng-container>
      </div>
      
      <!-- ·Éû·É†·Éù·Éì·É£·É•·É¢·Éò·É° ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê -->
      <div class="product-info">
        <h3>{{ product.title }}</h3>
        <p class="product-category">{{ product.category | categoryTranslate }}</p>
        <p class="product-price">{{ product.price }} ‚Çæ</p>
        <p class="product-year">{{ 'PRODUCTS.YEAR' | translate }}: {{ product.year }}</p>
        <p class="product-location">{{ product.cities | cityTranslate }}</p>
        <p class="product-date">{{ 'PRODUCTS.ADDED' | translate }}: {{ formatDate(product.createdAt) }}</p>
      </div>
      
      <!-- ·Éõ·Éù·É•·Éõ·Éî·Éì·Éî·Éë·Éò·É° ·É¶·Éò·Éö·Éê·Éô·Éî·Éë·Éò -->
      <div class="product-actions">
        <button mat-flat-button class="delete-btn" (click)="deleteProduct(product._id!); $event.stopPropagation()">
          üóëÔ∏è {{ 'PRODUCTS.DELETE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ NEW: Empty state when no products and not loading -->
<div class="no-products-message" *ngIf="userProducts.length === 0 && !isLoadingProducts" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
  <div style="font-size: 64px; margin-bottom: 20px;">üì¶</div>
  <h3 style="color: #6c757d; margin-bottom: 15px;">{{ 'PRODUCTS.NO_PRODUCTS_TITLE' | translate }}</h3>
  <p style="color: #6c757d; margin-bottom: 20px;">
    {{ 'PRODUCTS.NO_PRODUCTS_MESSAGE' | translate:{ max: MAX_PRODUCTS_ALLOWED } }}
  </p>
  <button 
    mat-flat-button 
    class="btn" 
    (click)="toggleProductForm()" 
    *ngIf="canAddMoreProducts()"
    style="background: #007bff; color: white; padding: 12px 24px;">
    ‚ûï {{ 'PRODUCTS.ADD_FIRST_PRODUCT' | translate }}
  </button>
</div>

<!-- ‚úÖ ENHANCED: Global loading overlay for uploads -->
<div class="loading-overlay" *ngIf="(isUploading || isCompressing) && !isLoadingProducts" 
     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center;">
  <div class="loading-spinner" style="text-align: center; color: white; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px);">
    <mat-progress-spinner diameter="60" color="primary" mode="indeterminate"></mat-progress-spinner>
    <div style="margin-top: 20px;">
      <h3 style="color: white; margin-bottom: 10px;">
        <span *ngIf="isCompressing">üñºÔ∏è {{ 'LOADING.COMPRESSING_IMAGES' | translate }}</span>
        <span *ngIf="isUploading && !isCompressing">üì§ {{ 'LOADING.UPLOADING_PRODUCT' | translate }}</span>
      </h3>
      <p style="color: #ccc; font-size: 14px;">
        <span *ngIf="isCompressing">{{ 'LOADING.PROCESSING_IMAGES' | translate }}...</span>
        <span *ngIf="isUploading && !isCompressing">{{ 'LOADING.SENDING_DATA' | translate }}...</span>
      </p>
    </div>
  </div>
</div>